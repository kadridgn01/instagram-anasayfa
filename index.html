<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Akış — Hikâyeler</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#12151c">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="assets/icon-192.png">

<style>
:root{
  --bg:#0f1115; --paper:#12151c; --ink:#e7e9ee; --muted:#9aa3af;
  --accent:#5da9ff; --border:#1f2330; --soft:#181c25; --radius:14px;
  --maxw:600px; --topbar-h:64px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
  font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif}
a{color:var(--accent);text-decoration:none}

/* Topbar */
.topbar{ position:fixed; inset:0 0 auto 0; z-index:50;
  height: calc(var(--topbar-h) + env(safe-area-inset-top));
  padding-top: env(safe-area-inset-top);
  background:#0e121b; border-bottom:1px solid var(--border);
  display:flex; align-items:flex-end; }
.row{max-width:var(--maxw); height:var(--topbar-h); margin:0 auto; width:100%;
  display:flex; align-items:center; justify-content:space-between; padding:0 16px;}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:20px;}
.logo{height:28px}
body{ padding-top: calc(var(--topbar-h) + env(safe-area-inset-top));
  padding-bottom: calc(90px + env(safe-area-inset-bottom)); }

/* Stories bar */
.stories{ max-width:var(--maxw); margin:0 auto; padding:10px 12px;
  display:flex; gap:12px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
.stories::-webkit-scrollbar{display:none}
.story-chip{ flex:0 0 auto; width:74px; text-align:center; font-size:12px; color:var(--muted);
  background:transparent; border:0; padding:0; outline:none; cursor:pointer; }
.story-chip:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }
.story-ring{ width:68px; height:68px; padding:2px; border-radius:50%;
  background: conic-gradient(from 0deg, #6ab0ff, #a873ff, #6ab0ff); display:grid; place-items:center; }
.story-chip.me .story-ring{ background: linear-gradient(180deg,#3e455a,#3e455a); }
.story-avatar{ width:64px; height:64px; border-radius:50%; object-fit:cover; border:0; }
.story-name{margin-top:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

/* Feed */
.feed{max-width:var(--maxw); margin:0 auto; padding:0 12px 16px; display:flex; flex-direction:column; gap:16px}
.card{background:var(--paper); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden}
.card .head{display:flex; align-items:center; gap:10px; padding:10px}
.card .head img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--soft)}
.card .head .user{font-weight:600}
.card .head .time{margin-left:auto;color:var(--muted);font-size:12px}
.card .media{width:100%; max-height:420px; object-fit:cover; display:block}
.card .actions{display:flex; gap:10px; padding:10px 12px}
.icon{cursor:pointer; user-select:none; font-size:20px}

/* Bottom bar */
.bottombar{ position:fixed; left:10px; right:10px; bottom: calc(env(safe-area-inset-bottom) + 8px);
  height:58px; background:var(--paper); border:1px solid var(--border); border-radius:14px;
  display:flex; justify-content:space-around; align-items:center; z-index:30;
  box-shadow: 0 10px 30px rgba(0,0,0,.35); }
.nav-item{display:flex; flex-direction:column; align-items:center; font-size:20px}
.nav-item span{font-size:12px; color:var(--muted); margin-top:2px}

/* === STORY VIEWER (tam ekran overlay) === */
.viewer{ position: fixed; inset: 0; z-index: 100; display:none; background:#000; padding:0; }
.viewer.active{display:block}
.viewer-inner{ position: relative; height: 100%; }
.viewer-stage{ position: absolute; inset: 0; height: 100svh; overflow:hidden; display:grid; place-items:center; }
.story-video{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; background:#000; }
.tapzone{ position:absolute; top:0; bottom:0; width:50%; }
.tapzone.left{left:0} .tapzone.right{right:0}

.viewer-top, .viewer-bottom{ position:absolute; left:0; right:0; z-index:2; pointer-events:none; }
.viewer-top{ top:0; padding:10px 12px; padding-top: calc(10px + env(safe-area-inset-top, 0px));
  background: linear-gradient(180deg, rgba(0,0,0,.55), transparent); display:flex; flex-direction:column; gap:6px; }
.viewer-bottom{ bottom:0; padding:10px 12px; padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  background: linear-gradient(0deg, rgba(0,0,0,.55), transparent); }
.viewer-top *,.viewer-bottom *{ pointer-events:auto; }

.progress{ position:relative; display:flex; gap:6px; height:3px; }
.seg{ flex:1; height:3px; background:rgba(255,255,255,.25); border-radius:2px; overflow:hidden; }
.seg > i{ display:block; height:100%; width:0%; background:#fff; transition:width .2s linear; }

.viewer-meta{ display:flex; align-items:center; gap:10px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.4); margin-top:4px; }
.viewer-meta img{ width:40px; height:40px; border-radius:50%; border:2px solid rgba(255,255,255,.35); object-fit:cover }
#vName{ font-size:16px; font-weight:700; }
#vTime{ font-size:13px; opacity:.8; }

/* alt: yorum kapsülü */
.commentbar{ display:flex; justify-content:center; align-items:center; gap:12px; }
.comment-pill{ appearance:none; border:0; cursor:pointer; padding:10px 14px; border-radius:999px;
  font-weight:700; font-size:14px; color:#e7e9ee; background:rgba(0,0,0,.35); backdrop-filter: blur(6px);}
.comment-pill:active{ transform:translateY(1px); }

/* küçük ses bildirimi */
.sound-toast{ position:absolute; left:12px; bottom:calc(70px + env(safe-area-inset-bottom, 0px));
  background:rgba(0,0,0,.6); color:#fff; padding:8px 10px; border-radius:10px;
  font-size:12px; opacity:0; pointer-events:none; transition:opacity .25s; }
.sound-toast.show{ opacity:1; }

/* ses + kapat butonları */
.viewer-sound,
.viewer-close{ appearance:none; border:0; cursor:pointer; background:rgba(0,0,0,.35); color:#fff;
  padding:8px 10px; border-radius:10px; font-weight:700; }
.viewer-sound{ margin-left:auto; }
.viewer-close{ margin-left:8px; }
</style>
</head>
<body>

<!-- TOP -->
<div class="topbar">
  <div class="row">
    <div class="brand">
      <img src="assets/logo.png" class="logo" alt="logo">
      <span>Akış</span>
    </div>
  </div>
</div>

<!-- STORIES -->
<section class="stories" id="stories"></section>

<!-- FEED -->
<section class="feed" id="feed"></section>

<!-- BOTTOM NAV -->
<nav class="bottombar">
  <a href="#" class="nav-item">🏠<span>Ana Sayfa</span></a>
  <a href="#" class="nav-item">🔍<span>Arama</span></a>
  <a href="#" class="nav-item">👤<span>Profil</span></a>
</nav>

<!-- STORY VIEWER MODAL -->
<div class="viewer" id="viewer" aria-hidden="true">
  <div class="viewer-inner">
    <div class="viewer-top">
      <div class="progress" id="progress"></div>
      <div class="viewer-meta">
        <img id="vAvatar" src="" alt="">
        <div>
          <div id="vName"></div>
          <div id="vTime" class="small">şimdi</div>
        </div>
        <button class="viewer-sound" id="btnSound" aria-label="Sesi aç/kapat">🔇</button>
        <button class="viewer-close" id="btnClose">✕</button>
      </div>
    </div>

    <div class="viewer-stage" id="stage">
      <video id="storyVideo" playsinline webkit-playsinline muted preload="metadata" class="story-video"></video>
      <div class="tapzone left" id="tapLeft"></div>
      <div class="tapzone right" id="tapRight"></div>
    </div>

    <div class="viewer-bottom commentbar" id="commentBar">
      <button class="comment-pill" id="btnComment">💬 Yorum yap</button>
    </div>
  </div>
</div>

<script>
const STORIES = [
  { id:"me",  name:"Sen",  avatar:"assets/me.jpg",  segments:[] },
  { id:"u1",  name:"Peri", avatar:"assets/peri.jpg",
    segments:[ { sources:["assets/1_h264.mp4","assets/1.webm"], dur:8, caption:"Yorum yap" } ] },
  { id:"u2",  name:"Selim", avatar:"assets/selim-av.jpg", segments:[] },
  { id:"u3",  name:"Mert",  avatar:"assets/mert-av.jpg",  segments:[] },
  { id:"u4",  name:"Ayça",  avatar:"assets/ayca-av.jpg",  segments:[] },
];

const FEED = [
  { user:"kadridgn",  avatar:"assets/kadri-av.jpg", img:"assets/kadri.jpg", time:"2s", likes:42 },
  { user:"okanerdemt", avatar:"assets/okan-av.jpg", img:"assets/okan.jpg", time:"1g",  likes:87 },
];

const $stories = document.getElementById('stories');
STORIES.forEach(s=>{
  const chip = document.createElement('button');
  chip.className = 'story-chip' + (s.id==='me' ? ' me':'');
  chip.innerHTML = `
    <div class="story-ring"><img class="story-avatar" src="${s.avatar}" alt="${s.name}"></div>
    <div class="story-name">${s.name}</div>`;
  chip.onclick = ()=>{ if (s.segments && s.segments.length) openViewerByStoryId(s.id);
                       else alert('Bu kullanıcıda hikâye yok.'); };
  $stories.appendChild(chip);
});

const $feed = document.getElementById('feed');
FEED.forEach(p=>{
  const card = document.createElement('article');
  card.className = 'card';
  card.innerHTML = `
    <div class="head"><img src="${p.avatar}" alt="${p.user}">
      <div class="user">${p.user}</div><div class="time">${p.time}</div></div>
    <img class="media" src="${p.img}" alt="">
    <div class="actions"><span class="icon like">❤️</span><span class="icon">💬</span><span class="icon">↗</span></div>`;
  const likeBtn = card.querySelector('.like'); let liked=false, likes=p.likes||0;
  likeBtn.onclick=()=>{ liked=!liked; likes += liked?1:-1; likeBtn.textContent = liked ? '💖' : '❤️'; };
  $feed.appendChild(card);
});

const viewer   = document.getElementById('viewer');
const video    = document.getElementById('storyVideo');
const progress = document.getElementById('progress');
const vName    = document.getElementById('vName');
const vAvatar  = document.getElementById('vAvatar');
const vTime    = document.getElementById('vTime');
const btnClose = document.getElementById('btnClose');
const btnSound = document.getElementById('btnSound');
const tapLeft  = document.getElementById('tapLeft');
const tapRight = document.getElementById('tapRight');
tapRight.addEventListener('click', ()=> nextSegment());
tapLeft .addEventListener('click',  ()=> prevSegment());

let curStoryIndex = 0, curSegIndex = 0, timerId = null;

function showToast(msg){
  const toast = document.createElement('div');
  toast.className = 'sound-toast'; toast.textContent = msg;
  viewer.appendChild(toast); setTimeout(()=>toast.classList.add('show'),10);
  setTimeout(()=>toast.remove(),1500);
}
function updateSoundUI(){
  btnSound.textContent = video.muted ? '🔇' : '🔊';
  btnSound.setAttribute('aria-label', video.muted ? 'Sesi aç' : 'Sesi kapat');
}
btnSound.onclick = ()=>{ video.muted = !video.muted; if(!video.muted) video.volume = 1; updateSoundUI(); };
video.addEventListener('volumechange', updateSoundUI);

async function exists(url){ try{ const r = await fetch(url,{method:'HEAD'}); return r.ok; }catch{ return false; } }
async function tryPlaySegment(seg){
  let candidates = seg.sources ? [...seg.sources] : (seg.src?[seg.src]:[]);
  for(const url of candidates){ if(!(await exists(url))) continue;
    video.src=url; video.currentTime=0; video.muted=true;
    try{ await video.play(); }catch{} return true; }
  return false;
}
function findStoryIndexById(id){ return STORIES.findIndex(s=>s.id===id); }

function openViewerByStoryId(id){
  curStoryIndex = Math.max(0, findStoryIndexById(id)); curSegIndex=0;
  viewer.classList.add('active'); viewer.setAttribute('aria-hidden','false');
  document.documentElement.style.overflow='hidden'; video.muted=true; updateSoundUI();
  loadCurrentSegment(true);
}
function closeViewer(){ viewer.classList.remove('active'); viewer.setAttribute('aria-hidden','true');
  clearTimer(); try{ video.pause(); }catch{} document.documentElement.style.overflow=''; }
btnClose.onclick = closeViewer;

async function loadCurrentSegment(){
  const story = STORIES[curStoryIndex]; const seg = story.segments[curSegIndex]; if(!seg){ closeViewer(); return; }
  vName.textContent = story.name; vAvatar.src = story.avatar; vTime.textContent = 'şimdi'; renderProgress(story.segments.length,curSegIndex);
  clearTimer(); const ok=await tryPlaySegment(seg); if(!ok){ nextSegment(); return; }
  video.onended = nextSegment; startTimer((seg.dur||7)*1000);
}
function renderProgress(total,activeIndex){ progress.innerHTML=''; for(let i=0;i<total;i++){ const seg=document.createElement('div'); seg.className='seg'; seg.innerHTML=`<i style="width:${i<activeIndex?100:0}%"></i>`; progress.appendChild(seg);} }
function startTimer(ms){ const start=performance.now(); const segBar=progress.children[curSegIndex].firstElementChild;
  function tick(now){ const pct=Math.min(100,((now-start)/ms)*100); segBar.style.width=pct+'%'; if(pct>=100){ nextSegment(); return;} timerId=requestAnimationFrame(tick);} timerId=requestAnimationFrame(tick);}
function clearTimer(){ if(timerId){ cancelAnimationFrame(timerId); timerId=null;} }

function nextSegment(){ const s=STORIES[curStoryIndex]; if(curSegIndex<s.segments.length-1){ curSegIndex++; loadCurrentSegment(); } else nextStory(); }
function prevSegment(){ if(curSegIndex>0){ curSegIndex--; loadCurrentSegment(); } else prevStory(true); }
function nextStory(){ if(curStoryIndex<STORIES.length-1 && STORIES[curStoryIndex+1].segments.length){ curStoryIndex++; curSegIndex=0; loadCurrentSegment(true);} else closeViewer();}
function prevStory(fromHead=false){ if(curStoryIndex>0 && STORIES[curStoryIndex-1].segments.length){ curStoryIndex--; curSegIndex=fromHead?STORIES[curStoryIndex].segments.length-1:0; loadCurrentSegment(true);} }

document.getElementById('btnComment').onclick = ()=>{ const txt=prompt('Yorum yaz:'); if(txt) alert('Yorum gönderildi (mock): '+txt); };
</script>
</body>
</html>
