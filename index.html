<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Akƒ±≈ü ‚Äî Hik√¢yeler</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#12151c">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="assets/icon-192.png">

<style>
:root{
  --bg:#0f1115; --paper:#12151c; --ink:#e7e9ee; --muted:#9aa3af;
  --accent:#5da9ff; --border:#1f2330; --soft:#181c25; --radius:14px;
  --maxw:600px; --topbar-h:64px;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
  font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif}
a{color:var(--accent);text-decoration:none}

/* Topbar */
.topbar{
  position:fixed; inset:0 0 auto 0; z-index:50;
  height: calc(var(--topbar-h) + env(safe-area-inset-top));
  padding-top: env(safe-area-inset-top);
  background:#0e121b; border-bottom:1px solid var(--border);
  display:flex; align-items:flex-end;
}
.row{max-width:var(--maxw); height:var(--topbar-h); margin:0 auto; width:100%;
  display:flex; align-items:center; justify-content:space-between; padding:0 16px;}
.brand{display:flex; align-items:center; gap:10px; font-weight:800; font-size:20px;}
.logo{height:28px}

/* Sayfa paddings */
body{
  padding-top: calc(var(--topbar-h) + env(safe-area-inset-top));
  padding-bottom: calc(90px + env(safe-area-inset-bottom));
}

/* Stories bar */
.stories{
  max-width:var(--maxw); margin:0 auto; padding:10px 12px;
  display:flex; gap:12px; overflow-x:auto; -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}
.stories::-webkit-scrollbar{display:none}
.story-chip{
  flex:0 0 auto; width:74px; text-align:center; font-size:12px; color:var(--muted);
  background:transparent; border:0; padding:0; outline:none; cursor:pointer;
}
.story-chip:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }
.story-ring{
  width:68px; height:68px; padding:2px; border-radius:50%;
  background: conic-gradient(from 0deg, #6ab0ff, #a873ff, #6ab0ff);
  display:grid; place-items:center;
}
.story-chip.me .story-ring{ background: linear-gradient(180deg,#3e455a,#3e455a); }
.story-avatar{ width:64px; height:64px; border-radius:50%; object-fit:cover; border:0; }
.story-name{margin-top:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

/* Feed */
.feed{max-width:var(--maxw); margin:0 auto; padding:0 12px 16px; display:flex; flex-direction:column; gap:16px}
.card{background:var(--paper); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden}
.card .head{display:flex; align-items:center; gap:10px; padding:10px}
.card .head img{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid var(--soft)}
.card .head .user{font-weight:600}
.card .head .time{margin-left:auto;color:var(--muted);font-size:12px}
.card .media{width:100%; max-height:420px; object-fit:cover; display:block}
.card .actions{display:flex; gap:10px; padding:10px 12px}
.icon{cursor:pointer; user-select:none; font-size:20px}

/* Bottom bar */
.bottombar{
  position:fixed; left:10px; right:10px; bottom: calc(env(safe-area-inset-bottom) + 8px);
  height:58px; background:var(--paper); border:1px solid var(--border); border-radius:14px;
  display:flex; justify-content:space-around; align-items:center; z-index:30;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
}
.nav-item{display:flex; flex-direction:column; align-items:center; font-size:20px}
.nav-item span{font-size:12px; color:var(--muted); margin-top:2px}

/* STORY VIEWER (modal) */
.viewer{
  position:fixed; inset:0; z-index:100; display:none;
  background:#000;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}
.viewer.active{display:block}
.viewer-inner{ height:100%; display:grid; grid-template-rows:auto 1fr auto; }
.viewer-top{ padding:10px 12px; position:relative; }
.progress{ display:flex; gap:6px; position:absolute; left:0; right:0; top:0; padding:10px 12px; }
.seg{ flex:1; height:3px; background:rgba(255,255,255,.25); border-radius:2px; overflow:hidden; }
.seg > i{ display:block; height:100%; width:0%; background:#fff; transition:width .2s linear; }
.viewer-meta{ display:flex; align-items:center; gap:10px; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.4); }
.viewer-meta img{width:32px; height:32px; border-radius:50%; border:2px solid rgba(255,255,255,.35); object-fit:cover}
.viewer-close{ margin-left:auto; appearance:none; border:0; background:rgba(0,0,0,.35); color:#fff;
  padding:6px 10px; border-radius:10px; font-weight:700; cursor:pointer; }

/* Video alanƒ± */
.viewer-stage{ position:relative; overflow:hidden; display:grid; place-items:center; }
.story-video{ width:100%; height:100%; object-fit:cover; max-height:100vh; background:#000; }
.tapzone{ position:absolute; top:0; bottom:0; width:50%; }
.tapzone.left{left:0} .tapzone.right{right:0}

/* Bottom controls */
.viewer-bottom{
  display:flex; align-items:center; justify-content:space-between; padding:10px 12px; color:#fff;
  background: linear-gradient(180deg, transparent, rgba(0,0,0,.35));
}
.ctrl{appearance:none; border:0; background:rgba(0,0,0,.35); color:#fff; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer}
.small{font-size:13px; opacity:.85}

/* === STORY FULLSCREEN PATCH === */
.viewer{
  position: fixed; inset: 0; z-index: 100;
  background:#000;
  padding: 0;
}
.viewer-inner{ position: relative; height: 100%; }
.viewer-stage{
  position: absolute; inset: 0;
  height: 100svh;
  overflow: hidden; display: grid; place-items: center;
}
.story-video{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit: cover;
  object-position: center;
  background:#000;
}
.viewer-top,
.viewer-bottom{
  position: absolute; left:0; right:0; z-index: 2;
  pointer-events: none;
}
.viewer-top{
  top: 0;
  padding: 10px 12px;
  padding-top: calc(10px + env(safe-area-inset-top, 0px));
  background: linear-gradient(180deg, rgba(0,0,0,.55), transparent);
}
.viewer-bottom{
  bottom: 0;
  padding: 10px 12px;
  padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
  background: linear-gradient(0deg, rgba(0,0,0,.55), transparent);
}
.viewer-top *,.viewer-bottom *{ pointer-events:auto; }
.progress{
  position: absolute; left:0; right:0;
  top: calc(env(safe-area-inset-top, 0px) + 6px);
  padding: 0 12px;
  display:flex; gap:6px;
}

/* STORY HEADER DENGELƒ∞ BOYUTLAR */
.viewer-meta img{
  width: 40px;     /* 32px yerine 40px ‚Üí daha b√ºy√ºk ama √ßok deƒüil */
  height: 40px;
  border-width: 2px;
}

#vName{
  font-size: 16px;   /* 18px deƒüil, daha dengeli */
  font-weight: 700;
}

#vTime{
  font-size: 13px;   /* k√º√ß√ºk kalsƒ±n */
  opacity: 0.8;
}

/* Progress bar biraz daha yukarƒ± ve ince */
.progress{
  top: calc(env(safe-area-inset-top, 0px) + 4px);
  height: 3px;
}
.seg{ height:3px; }


/* === END PATCH === */
</style>
</head>
<body>

<!-- TOP -->
<div class="topbar">
  <div class="row">
    <div class="brand">
      <img src="assets/logo.png" class="logo" alt="logo">
      <span>Akƒ±≈ü</span>
    </div>
  </div>
</div>

<!-- STORIES -->
<section class="stories" id="stories"></section>

<!-- FEED -->
<section class="feed" id="feed"></section>

<!-- BOTTOM NAV -->
<nav class="bottombar">
  <a href="#" class="nav-item">üè†<span>Ana Sayfa</span></a>
  <a href="#" class="nav-item">üîç<span>Arama</span></a>
  <a href="#" class="nav-item">üë§<span>Profil</span></a>
</nav>

<!-- STORY VIEWER MODAL -->
<div class="viewer" id="viewer" aria-hidden="true">
  <div class="viewer-inner">
    <div class="viewer-top">
      <div class="progress" id="progress"></div>
      <div class="viewer-meta">
        <img id="vAvatar" src="" alt="">
        <div>
          <div id="vName" style="font-weight:700"></div>
          <div id="vTime" class="small">≈üimdi</div>
        </div>
        <button class="viewer-close" id="btnClose">‚úï</button>
      </div>
    </div>

    <div class="viewer-stage" id="stage">
      <video id="storyVideo" playsinline webkit-playsinline muted preload="metadata" class="story-video"></video>
      <div class="tapzone left" id="tapLeft"></div>
      <div class="tapzone right" id="tapRight"></div>
    </div>

    <div class="viewer-bottom">
      <button class="ctrl" id="btnMute">üîá Ses</button>
      <div class="small" id="vCaption"></div>
      <button class="ctrl" id="btnPause">‚è∏Ô∏é Duraklat</button>
    </div>
  </div>
</div>

<script>
/* --------------------------
   1) VERƒ∞: Hƒ∞K√ÇYELER & FEED
---------------------------*/
const STORIES = [
  {
    id:"me",
    name:"Sen",
    avatar:"assets/me.jpg",
  },
  {
    id:"u1",
    name:"Peri",
    avatar:"assets/peri.jpg",
    segments:[
      // ƒ∞stersen 'sources' ile birden fazla format ver:
      // { sources:["assets/stories/u1/1_h264.mp4","assets/stories/u1/1.webm"], dur:8, caption:"Yorum yap" }
      { src:"assets/1_h264.mp4", dur:8, caption:"Yorum yap" }
    ]
  },
  {
    id:"u2",
    name:"Selim",
    avatar:"assets/selim-av.jpg",
  },
  {
    id:"u2",
    name:"Mert",
    avatar:"assets/mert-av.jpg",
  },
  {
    id:"u2",
    name:"Ay√ßa",
    avatar:"assets/ayca-av.jpg",
  },
];

const FEED = [
  { user:"kadridgn",  avatar:"assets/kadri-av.jpg", img:"assets/kadri.jpg", time:"2s", likes:42 },
  { user:"okanerdemt", avatar:"assets/okan-av.jpg", img:"assets/okan.jpg", time:"1g",  likes:87 },
];

/* --------------------------
   2) STORIES RENDER
---------------------------*/
const $stories = document.getElementById('stories');
STORIES.forEach(s=>{
  const chip = document.createElement('button');
  chip.className = 'story-chip' + (s.id==='me' ? ' me':'');
  chip.setAttribute('aria-label', s.name + ' hik√¢yeleri');
  chip.innerHTML = `
    <div class="story-ring">
      <img class="story-avatar" src="${s.avatar}" alt="${s.name}">
    </div>
    <div class="story-name">${s.name}</div>
  `;
  chip.onclick = ()=> openViewerByStoryId(s.id);
  $stories.appendChild(chip);
});

/* --------------------------
   3) FEED RENDER
---------------------------*/
const $feed = document.getElementById('feed');
FEED.forEach(p=>{
  const card = document.createElement('article');
  card.className = 'card';
  card.innerHTML = `
    <div class="head">
      <img src="${p.avatar}" alt="${p.user}">
      <div class="user">${p.user}</div>
      <div class="time">${p.time}</div>
    </div>
    <img class="media" src="${p.img}" alt="">
    <div class="actions">
      <span class="icon like">‚ù§Ô∏è</span>
      <span class="icon">üí¨</span>
      <span class="icon">‚Üó</span>
    </div>
  `;
  const likeBtn = card.querySelector('.like');
  let liked=false, likes=p.likes||0;
  likeBtn.onclick=()=>{
    liked=!liked; likes += liked?1:-1;
    likeBtn.textContent = liked ? 'üíñ' : '‚ù§Ô∏è';
  };
  $feed.appendChild(card);
});

/* --------------------------
   4) STORY VIEWER + G√úVENLƒ∞ VIDEO Y√úKLEME
---------------------------*/
const viewer   = document.getElementById('viewer');
const video    = document.getElementById('storyVideo');
const progress = document.getElementById('progress');
const vName    = document.getElementById('vName');
const vAvatar  = document.getElementById('vAvatar');
const vTime    = document.getElementById('vTime');
const vCaption = document.getElementById('vCaption');
const btnClose = document.getElementById('btnClose');
const btnMute  = document.getElementById('btnMute');
const btnPause = document.getElementById('btnPause');
const tapLeft  = document.getElementById('tapLeft');
const tapRight = document.getElementById('tapRight');

let curStoryIndex = 0;
let curSegIndex   = 0;
let timerId       = null;
let playing       = true;

/* ---- k√º√ß√ºk debug ---- */
function toast(msg){
  console.log('[story]', msg);
}

/* URL var mƒ± hƒ±zlƒ± kontrol (GitHub Pages HEAD‚Äôe izin veriyor) */
async function exists(url){
  try{ const r = await fetch(url, {method:'HEAD'}); return r.ok; }catch{ return false; }
}

/* Bu segment i√ßin oynatƒ±labilir kaynaƒüƒ± bul ve √ßalƒ±≈ütƒ±r */
async function tryPlaySegment(seg){
  // 1) Eƒüer seg.sources varsa onu kullan
  let candidates = Array.isArray(seg.sources) ? [...seg.sources] : [];

  // 2) Yoksa seg.src‚Äôden t√ºrev olu≈ütur (√∂rn. 1.mp4 ‚Üí 1_h264.mp4, 1.webm)
  if(!candidates.length && seg.src){
    candidates.push(seg.src);
    if(seg.src.endsWith('.mp4')){
      const base = seg.src.replace(/\.mp4$/i,'');
      candidates.push(base + '_h264.mp4');
      candidates.push(base + '.webm');
    }
  }

  // 3) Sƒ±rayla dene
  for(const url of candidates){
    if(!(await exists(url))) { toast('bulunamadƒ±: '+url); continue; }
    // kaynaklarƒ± <source> ile set etmek istemezsek direkt src veriyoruz:
    video.src = url;
    video.currentTime = 0;
    video.muted = true;
    try{
      await video.play();
      toast('oynatƒ±lƒ±yor: '+url);
      return true;
    }catch(e){
      toast('autoplay engeli: '+url);
      // kullanƒ±cƒ± tƒ±klayƒ±nca ba≈ülayacak; yine de bu kaynaƒüƒ± kabul edelim
      return true;
    }
  }
  return false;
}

function findStoryIndexById(id){
  return STORIES.findIndex(s=>s.id===id);
}

function openViewerByStoryId(id){
  curStoryIndex = Math.max(0, findStoryIndexById(id));
  curSegIndex   = 0;
  viewer.classList.add('active');
  viewer.setAttribute('aria-hidden','false');
  document.documentElement.style.overflow='hidden';
  loadCurrentSegment(true);
}

function closeViewer(){
  viewer.classList.remove('active');
  viewer.setAttribute('aria-hidden','true');
  clearTimer();
  try { video.pause(); } catch(e){}
  document.documentElement.style.overflow='';
}

btnClose.onclick = closeViewer;

async function loadCurrentSegment(first=false){
  const story = STORIES[curStoryIndex];
  const segs  = story.segments;
  const seg   = segs[curSegIndex];

  // meta
  vName.textContent = story.name;
  vAvatar.src = story.avatar;
  vTime.textContent = '≈üimdi';
  vCaption.textContent = seg.caption || '';

  // progress bar
  renderProgress(segs.length, curSegIndex);

  // video
  clearTimer();
  playing = true;
  btnPause.textContent = '‚è∏Ô∏é Duraklat';

  const ok = await tryPlaySegment(seg);
  if(!ok){
    alert('Video y√ºklenemedi (yol/codec). L√ºtfen H.264 + AAC y√ºklendiƒüinden emin ol.');
    nextSegment(); // ge√ß
    return;
  }

  video.onended = nextSegment;

  // emniyet kemeri: video ended gelmezse s√ºreye g√∂re
  startTimer((seg.dur || 7) * 1000);
}

function renderProgress(total, activeIndex){
  progress.innerHTML = '';
  for(let i=0;i<total;i++){
    const seg = document.createElement('div');
    seg.className='seg';
    seg.innerHTML = `<i style="width:${i < activeIndex ? 100 : (i===activeIndex?0:0)}%"></i>`;
    progress.appendChild(seg);
  }
}

function startTimer(ms){
  const start = performance.now();
  const segBar = progress.children[curSegIndex].firstElementChild;
  function tick(now){
    const elapsed = now - start;
    const pct = Math.min(100, (elapsed / ms) * 100);
    segBar.style.width = pct + '%';
    if(pct >= 100){ nextSegment(); return; }
    timerId = requestAnimationFrame(tick);
  }
  timerId = requestAnimationFrame(tick);
}
function clearTimer(){ if(timerId){ cancelAnimationFrame(timerId); timerId=null; } }

function nextSegment(){
  const story = STORIES[curStoryIndex];
  if(curSegIndex < story.segments.length - 1){
    curSegIndex++;
    loadCurrentSegment();
  }else{
    nextStory();
  }
}
function prevSegment(){
  if(curSegIndex > 0){
    curSegIndex--;
    loadCurrentSegment();
  }else{
    prevStory(true);
  }
}
function nextStory(){
  if(curStoryIndex < STORIES.length - 1){
    curStoryIndex++; curSegIndex=0; loadCurrentSegment(true);
  }else{
    closeViewer();
  }
}
function prevStory(fromHead=false){
  if(curStoryIndex > 0){
    curStoryIndex--; curSegIndex = fromHead ? STORIES[curStoryIndex].segments.length-1 : 0;
    loadCurrentSegment(true);
  }
}

/* Tap b√∂lgeleri */
tapRight.addEventListener('click', ()=> nextSegment());
tapLeft .addEventListener('click',  ()=> prevSegment());

/* Pause / Play */
btnPause.onclick = ()=>{
  if(playing){
    video.pause(); clearTimer(); playing=false; btnPause.textContent='‚ñ∂Ô∏é Oynat';
  }else{
    video.play(); startTimer( (STORIES[curStoryIndex].segments[curSegIndex].dur || 7) * 1000 ); playing=true; btnPause.textContent='‚è∏Ô∏é Duraklat';
  }
};

/* Mute */
btnMute.onclick = ()=>{
  video.muted = !video.muted;
  btnMute.textContent = video.muted ? 'üîá Ses' : 'üîä Ses';
};

/* Klavye (desktop) */
document.addEventListener('keydown', (e)=>{
  if(!viewer.classList.contains('active')) return;
  if(e.key==='ArrowRight') nextSegment();
  if(e.key==='ArrowLeft')  prevSegment();
  if(e.key==='Escape')     closeViewer();
  if(e.key===' ')          btnPause.click();
  if(e.key==='m' || e.key==='M') btnMute.click();
});

/* Touch swipe to close (a≈üaƒüƒ± √ßek) */
let startY=null;
document.getElementById('stage').addEventListener('touchstart', (e)=>{ startY = e.touches[0].clientY; }, {passive:true});
document.getElementById('stage').addEventListener('touchmove', (e)=>{
  if(startY===null) return;
  const dy = e.touches[0].clientY - startY;
  if(dy > 90){ closeViewer(); startY=null; }
}, {passive:true});
document.getElementById('stage').addEventListener('touchend', ()=>{ startY=null; });

/* Dƒ±≈üarƒ±dan √ßaƒüƒ±rmak istersen:
   openViewerByStoryId('u1');
*/
</script>
</body>
</html>
